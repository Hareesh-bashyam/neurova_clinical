============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0
django: version: 5.2.10, settings: neurova_backend.settings (from ini)
rootdir: C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend
configfile: pytest.ini
plugins: Faker-40.1.2, cov-7.0.0, django-4.11.1
collected 7 items

backend\clinical\tests\test_pdf_audit.py F                               [ 14%]
backend\clinical\tests\test_submission_integrity.py F                    [ 28%]
tests\e2e\test_full_pathology_flow.py F                                  [ 42%]
backend\clinical\reporting\tests\test_report_pdf_v1.py ....              [100%]

================================== FAILURES ===================================
___________________ test_pdf_export_creates_at_audit_event ____________________

    @pytest.mark.django_db
    def test_pdf_export_creates_at_audit_event():
        c = Client()
        org = Organization.objects.create(id=uuid.uuid4(), name="Org", address="Addr")
    
        # 1. Create Order
        resp = c.post("/api/v1/clinical/orders/",
                      data={
                          "organization_id": str(org.id),
                          "patient_name": "Test Patient",
                          "encounter_type": "OPD",
                          "administration_mode": "IN_CLINIC",
                          "battery_code": "CMHA_V1",
                          "patient_age": 30,
                          "patient_gender": "Male",
                      },
                      content_type="application/json",
                      **{"HTTP_X_ORG_ID": str(org.id)}
                      )
        assert resp.status_code == 201
        order_id = resp.json()["order_id"]
        session_id = resp.json()["session_id"]
    
        # 2. Start Session (updates order/session status)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/start/",
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"]["test_code"]
    
        # 3. Simulate completion (Directly submitting required tests to be faster, or mocking)
        # Using the existing flow from e2e test to be safe and integration-like
    
        # PHQ9 (Test 1)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*9, "test_code": current_test_code}, # Last item > 0 triggers safety checks but completing is fine
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # MDQ (Test 2)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":{"symptom_yes_count":0,"co_occur":False,"impairment":"NONE"}, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # GAD7 (Test 3)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*7, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # PSS10 (Test 4)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*10, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # AUDIT (Test 5)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*10, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # STOP_BANG (Test 6)
        # This should complete the session
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*8, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
    
        if resp.status_code != 200:
            print(f"STOP_BANG submit failed: {resp.status_code} {resp.content}")
    
        assert resp.status_code == 200
        assert resp.json()["data"].get("completed") is True
    
        # 4. Generate Report
        resp = c.post(f"/api/v1/clinical/orders/{order_id}/generate_report/",
                      content_type="application/json",
                      **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
    
        # 5. Download PDF
        pdf_resp = c.get(f"/api/v1/clinical/orders/{order_id}/report/pdf/", **{"HTTP_X_ORG_ID": str(org.id)})
>       assert pdf_resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response status_code=500, "application/json">.status_code

backend\clinical\tests\test_pdf_audit.py:101: AssertionError
---------------------------- Captured stderr call -----------------------------
{"ts": "2026-01-26T04:02:46.315850Z", "level": "ERROR", "logger": "neurova.api", "msg": "api_exception", "request_id": "7c9ad671-9525-44ea-8077-fb3182182117", "path": "/api/v1/clinical/orders/4e6c2033-7e2e-4636-9531-997b4cba5c06/report/pdf/", "method": "GET", "exc_info": "Traceback (most recent call last):\n  File \"C:\\Users\\Hareesh\\Desktop\\Main-Projects\\neurova_backend_project\\neurova_backend\\venv_win\\Lib\\site-packages\\rest_framework\\views.py\", line 512, in dispatch\n    response = handler(request, *args, **kwargs)\n  File \"C:\\Users\\Hareesh\\Desktop\\Main-Projects\\neurova_backend_project\\neurova_backend\\backend\\clinical\\views.py\", line 459, in get\n    ClinicalAuditEvent.objects.create(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        organization_id=order.organization_id,\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n        details={\"file_name\": f\"report_{order_id}.pdf\"},\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Hareesh\\Desktop\\Main-Projects\\neurova_backend_project\\neurova_backend\\venv_win\\Lib\\site-packages\\django\\db\\models\\manager.py\", line 87, in manager_method\n    return getattr(self.get_queryset(), name)(*args, **kwargs)\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Hareesh\\Desktop\\Main-Projects\\neurova_backend_project\\neurova_backend\\venv_win\\Lib\\site-packages\\django\\db\\models\\query.py\", line 663, in create\n    obj = self.model(**kwargs)\n  File \"C:\\Users\\Hareesh\\Desktop\\Main-Projects\\neurova_backend_project\\neurova_backend\\venv_win\\Lib\\site-packages\\django\\db\\models\\base.py\", line 569, in __init__\n    raise TypeError(\n    ...<2 lines>...\n    )\nTypeError: ClinicalAuditEvent() got unexpected keyword arguments: 'details'"}
{"ts": "2026-01-26T04:02:46.343324Z", "level": "ERROR", "logger": "django.request", "msg": "Internal Server Error: /api/v1/clinical/orders/4e6c2033-7e2e-4636-9531-997b4cba5c06/report/pdf/", "status_code": 500}
------------------------------ Captured log call ------------------------------
ERROR    neurova.api:api_exception_handler.py:16 api_exception
Traceback (most recent call last):
  File "C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\venv_win\Lib\site-packages\rest_framework\views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\backend\clinical\views.py", line 459, in get
    ClinicalAuditEvent.objects.create(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        organization_id=order.organization_id,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
        details={"file_name": f"report_{order_id}.pdf"},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\venv_win\Lib\site-packages\django\db\models\manager.py", line 87, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\venv_win\Lib\site-packages\django\db\models\query.py", line 663, in create
    obj = self.model(**kwargs)
  File "C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\venv_win\Lib\site-packages\django\db\models\base.py", line 569, in __init__
    raise TypeError(
    ...<2 lines>...
    )
TypeError: ClinicalAuditEvent() got unexpected keyword arguments: 'details'
ERROR    django.request:log.py:253 Internal Server Error: /api/v1/clinical/orders/4e6c2033-7e2e-4636-9531-997b4cba5c06/report/pdf/
___________________ test_submission_integrity_vulnerability ___________________

    @pytest.mark.django_db
    def test_submission_integrity_vulnerability():
        """
        Reproduction test for submission integrity vulnerability.
        VERIFIES that replayed submissions are accepted and advance the battery index incorrectly.
        """
        c = Client()
        org = Organization.objects.create(id=uuid.uuid4(), name="Org", address="Addr")
    
        # 1. Create order for CMHA_V1 (PHQ9 -> MDQ -> GAD7 ...)
        resp = c.post("/api/v1/clinical/orders/",
                      data={
                          "organization_id": str(org.id),
                          "patient_name": "Patient",
                          "encounter_type": "OPD",
                          "administration_mode": "IN_CLINIC",
                          "battery_code": "CMHA_V1"
                      },
                      content_type="application/json",
                      **{"HTTP_X_ORG_ID": str(org.id)}
                      )
        assert resp.status_code == 201
        session_id = resp.json()["session_id"]
    
        # 2. Start session
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/start/",
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        assert resp.json()["data"]["test_code"] == "PHQ9"
    
        # 3. Submit PHQ9 (Valid)
        phq9_payload = {"raw_responses": [0,0,0,0,0,0,0,0,0]}
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data=phq9_payload,
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
    
        assert resp.status_code == 200
        data = resp.json()["data"]
        assert data["next_test_code"] == "MDQ"
        assert data["next_test_index"] == 1
    
        # 4. ATTACK: Replay PHQ9 submission
        # We send the EXACT SAME payload again.
        # The server expects MDQ, but we send PHQ9 data (array of 9 zeros).
        # MDQ expects dict, but server might not validate schema deeply enough, OR
        # if we send generic data it might just accept it.
        # Even worse: simple replay.
    
        resp_attack = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data=phq9_payload,  # Replaying PHQ9 data
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
    
        # CURRENT VULNERABLE BEHAVIOR:
        # Server accepts it, treating it as the submission for MDQ (Index 1).
        # Advances to GAD7 (Index 2).
    
        if resp_attack.status_code == 200:
            data_attack = resp_attack.json()
            print(f"\n[VULNERABILITY CONFIRMED] Attack succeeded. Advanced to: {data_attack.get('next_test_code')}")
    
            # If bug exists, we are now at GAD7
            if data_attack.get("next_test_code") == "GAD7":
                pytest.fail("VULNERABILITY CONFIRMED: Replayed PHQ9 submission caused skip of MDQ.")
    
        # If fixed, this should be 409 or 400
>       assert resp_attack.status_code in (400, 409), f"Should recognize mismatch/replay. Got {resp_attack.status_code}"
E       AssertionError: Should recognize mismatch/replay. Got 200
E       assert 200 in (400, 409)
E        +  where 200 = <Response status_code=200, "application/json">.status_code

backend\clinical\tests\test_submission_integrity.py:74: AssertionError
---------------------------- Captured stdout call -----------------------------

[VULNERABILITY CONFIRMED] Attack succeeded. Advanced to: None
__________________________ test_full_pathology_flow ___________________________

tmp_path = WindowsPath('C:/Users/Hareesh/AppData/Local/Temp/pytest-of-Hareesh/pytest-22/test_full_pathology_flow0')

    @pytest.mark.django_db
    def test_full_pathology_flow(tmp_path):
        """
        PHASE A+B+C 첫 END-TO-END PROOF
    
        \u2714 Full workflow
        \u2714 Immutability preserved
        \u2714 PDF generation verified (internal)
        \u2714 Audit trail verified
        """
    
        client = APIClient()
    
        # -----------------------
        # Org + Clinician
        # -----------------------
        org = Organization.objects.create(
            name="E2E Clinic",
            code="E2E_ORG",
            signature_required=True
        )
    
        clinician = User.objects.create_user(
            username="doctor@e2e.com",
            password="pass"
        )
    
        UserProfile.objects.create(
            user=clinician,
            organization=org,
            role="CLINICIAN"
        )
    
        client.force_authenticate(user=clinician)
    
        # -----------------------
        # Catalog
        # -----------------------
        instrument = Instrument.objects.create(
            organization=org,
            code="PHQ9",
            name="PHQ-9"
        )
    
        TestDefinition.objects.create(
            organization=org,
            instrument=instrument,
            code="PHQ9_STD",
            name="PHQ-9",
            language="en",
            json_schema={"type": "object"},
            scoring_spec={},
            is_active=True
        )
    
        panel = Panel.objects.create(
            organization=org,
            code="PANEL_E2E",
            name="Mental Health Panel"
        )
    
        # -----------------------
        # Patient
        # -----------------------
        patient = Patient.objects.create(
            organization=org,
            name="E2E Patient"
        )
    
        # -----------------------
        # Order
        # -----------------------
        order = Order.objects.create(
            organization=org,
            patient=patient,
            panel=panel
        )
    
        # -----------------------
        # Session
        # -----------------------
        session = Session.objects.create(
            organization=org,
            order=order,
            status="COMPLETED"
        )
    
        # -----------------------
        # Report (READY 청 immutable)
        # -----------------------
        report = Report.objects.create(
            organization=org,
            session=session,
            status="READY",
            report_json={"result": "ok"}
        )
    
        # -----------------------
        # Signature
        # -----------------------
        ReportSignature.objects.create(
            organization=org,
            report=report,
            signer_name="Dr E2E",
            signer_reg_no="E2E-001",
            signer_role="CLINICIAN"
        )
    
        # -----------------------
        # Release
        # -----------------------
        resp = client.post(f"/api/v1/reports/{report.id}/release/")
        assert resp.status_code == 200
    
        # Original report must remain immutable
        report.refresh_from_db()
        assert report.status == "READY"
    
        # Audit log must exist
        assert AuditLog.objects.filter(
            organization=org,
            action="REPORT_RELEASED",
            entity_type="Report",
            entity_id=str(report.id),
        ).exists()
    
        # -----------------------
        # PDF GENERATION (INTERNAL)
        # -----------------------
        pdf_path = tmp_path / "report.pdf"
    
        context = {
            "patient_name": patient.name,
            "session_id": session.id,
            "tests": [
                {
                    "code": "PHQ9",
                    "score": 5,
                    "severity": "Mild"
                }
            ],
            "critical_self_harm": False,
            "engine_version": "v1",
            "report_schema_version": "1.0",
            "organization": {"name": org.name, "address": "Some Address"},
            "report_id": str(report.id),
            "audit": {"created_at": "2026-01-08T23:15:00Z"},
        }
    
>       generate_report_pdf(str(pdf_path), context)

tests\e2e\test_full_pathology_flow.py:166: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

buffer = 'C:\\Users\\Hareesh\\AppData\\Local\\Temp\\pytest-of-Hareesh\\pytest-22\\test_full_pathology_flow0\\report.pdf'
report_json = {'audit': {'created_at': '2026-01-08T23:15:00Z'}, 'critical_self_harm': False, 'engine_version': 'v1', 'organization': {'address': 'Some Address', 'name': 'E2E Clinic'}, ...}

    def generate_report_pdf(buffer, report_json):
        c = canvas.Canvas(buffer, pagesize=A4)
        width, height = A4
        y = height - 40
    
        # SECTION 1 첫 HEADER
        c.setFont("Helvetica-Bold", 12)
        c.drawString(40, y, report_json["organization"]["name"])
    
        c.setFont("Helvetica", 9)
        y -= 14
        c.drawString(40, y, report_json["organization"]["address"] or "")
    
        c.setFont("Helvetica-Bold", 14)
        c.drawRightString(width - 40, height - 40, "Psychiatric Assessment Report")
    
        y -= 30
        c.setFont("Helvetica", 9)
        c.drawString(40, y, f"Report ID: {report_json['report_id']}")
        y -= 12
        c.drawString(40, y, f"Report Date: {report_json['audit']['created_at']}")
    
        # SECTION 2 첫 PATIENT & ENCOUNTER
        y -= 30
        c.setFont("Helvetica-Bold", 11)
        c.drawString(40, y, "Patient & Encounter Details")
    
        y -= 16
        c.setFont("Helvetica", 9)
>       p = report_json["patient"]
            ^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'patient'

reports\pdf.py:36: KeyError
============================== warnings summary ===============================
catalog\models.py:23
  C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\catalog\models.py:23: PytestCollectionWarning: cannot collect test class 'TestDefinition' because it has a __init__ constructor (from: tests/e2e/test_full_pathology_flow.py)
    class TestDefinition(models.Model):

backend/clinical/tests/test_pdf_audit.py::test_pdf_export_creates_at_audit_event
backend/clinical/tests/test_pdf_audit.py::test_pdf_export_creates_at_audit_event
  C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\neurova_backend\settings.py:26: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "ts": datetime.utcnow().isoformat() + "Z",

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED backend/clinical/tests/test_pdf_audit.py::test_pdf_export_creates_at_audit_event
FAILED backend/clinical/tests/test_submission_integrity.py::test_submission_integrity_vulnerability
FAILED tests/e2e/test_full_pathology_flow.py::test_full_pathology_flow - KeyE...
================== 3 failed, 4 passed, 3 warnings in 13.31s ===================
