============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0
django: version: 5.2.10, settings: neurova_backend.settings (from ini)
rootdir: C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend
configfile: pytest.ini
plugins: Faker-40.1.2, cov-7.0.0, django-4.11.1
collected 7 items

backend\clinical\tests\test_pdf_audit.py F                               [ 14%]
backend\clinical\tests\test_submission_integrity.py F                    [ 28%]
tests\e2e\test_full_pathology_flow.py F                                  [ 42%]
backend\clinical\reporting\tests\test_report_pdf_v1.py ..F.              [100%]

================================== FAILURES ===================================
___________________ test_pdf_export_creates_at_audit_event ____________________

    @pytest.mark.django_db
    def test_pdf_export_creates_at_audit_event():
        c = Client()
        org = Organization.objects.create(id=uuid.uuid4(), name="Org", address="Addr")
    
        # 1. Create Order
        resp = c.post("/api/v1/clinical/orders/",
                      data={
                          "organization_id": str(org.id),
                          "patient_name": "Test Patient",
                          "encounter_type": "OPD",
                          "administration_mode": "IN_CLINIC",
                          "battery_code": "CMHA_V1",
                          "patient_age": 30,
                          "patient_gender": "Male",
                      },
                      content_type="application/json",
                      **{"HTTP_X_ORG_ID": str(org.id)}
                      )
        assert resp.status_code == 201
        order_id = resp.json()["order_id"]
        session_id = resp.json()["session_id"]
    
        # 2. Start Session (updates order/session status)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/start/",
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"]["test_code"]
    
        # 3. Simulate completion (Directly submitting required tests to be faster, or mocking)
        # Using the existing flow from e2e test to be safe and integration-like
    
        # PHQ9 (Test 1)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*9, "test_code": current_test_code}, # Last item > 0 triggers safety checks but completing is fine
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # MDQ (Test 2)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":{"symptom_yes_count":0,"co_occur":False,"impairment":"NONE"}, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # GAD7 (Test 3)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*7, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # PSS10 (Test 4)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*10, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # AUDIT (Test 5)
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*10, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        current_test_code = resp.json()["data"].get("next_test_code")
    
        # STOP_BANG (Test 6)
        # This should complete the session
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data={"raw_responses":[0]*8, "test_code": current_test_code},
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
    
        if resp.status_code != 200:
            print(f"STOP_BANG submit failed: {resp.status_code} {resp.content}")
    
        assert resp.status_code == 200
        assert resp.json()["data"].get("completed") is True
    
        # 4. Generate Report
        resp = c.post(f"/api/v1/clinical/orders/{order_id}/generate_report/",
                      content_type="application/json",
                      **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
    
        # 5. Download PDF
        pdf_resp = c.get(f"/api/v1/clinical/orders/{order_id}/report/pdf/", **{"HTTP_X_ORG_ID": str(org.id)})
        assert pdf_resp.status_code == 200
        assert pdf_resp["Content-Type"] == "application/pdf"
    
        # 6. Verify Audit Event
        audit_events = ClinicalAuditEvent.objects.filter(order_id=order_id, event_type="PDF_EXPORTED")
>       assert audit_events.exists()
E       assert False
E        +  where False = exists()
E        +    where exists = <QuerySet []>.exists

backend\clinical\tests\test_pdf_audit.py:106: AssertionError
___________________ test_submission_integrity_vulnerability ___________________

    @pytest.mark.django_db
    def test_submission_integrity_vulnerability():
        """
        Reproduction test for submission integrity vulnerability.
        VERIFIES that replayed submissions are accepted and advance the battery index incorrectly.
        """
        c = Client()
        org = Organization.objects.create(id=uuid.uuid4(), name="Org", address="Addr")
    
        # 1. Create order for CMHA_V1 (PHQ9 -> MDQ -> GAD7 ...)
        resp = c.post("/api/v1/clinical/orders/",
                      data={
                          "organization_id": str(org.id),
                          "patient_name": "Patient",
                          "encounter_type": "OPD",
                          "administration_mode": "IN_CLINIC",
                          "battery_code": "CMHA_V1"
                      },
                      content_type="application/json",
                      **{"HTTP_X_ORG_ID": str(org.id)}
                      )
        assert resp.status_code == 201
        session_id = resp.json()["session_id"]
    
        # 2. Start session
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/start/",
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
        assert resp.status_code == 200
        assert resp.json()["data"]["test_code"] == "PHQ9"
    
        # 3. Submit PHQ9 (Valid)
        phq9_payload = {"raw_responses": [0,0,0,0,0,0,0,0,0]}
        resp = c.post(f"/api/v1/clinical/sessions/{session_id}/submit_current/",
               data=phq9_payload,
               content_type="application/json",
               **{"HTTP_X_ORG_ID": str(org.id)})
    
        assert resp.status_code == 200
        data = resp.json()["data"]
        assert data["next_test_code"] == "MDQ"
>       assert data["next_test_index"] == 1
               ^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'next_test_index'

backend\clinical\tests\test_submission_integrity.py:47: KeyError
__________________________ test_full_pathology_flow ___________________________

tmp_path = WindowsPath('C:/Users/Hareesh/AppData/Local/Temp/pytest-of-Hareesh/pytest-21/test_full_pathology_flow0')

    @pytest.mark.django_db
    def test_full_pathology_flow(tmp_path):
        """
        PHASE A+B+C ù END-TO-END PROOF
    
        \u2714 Full workflow
        \u2714 Immutability preserved
        \u2714 PDF generation verified (internal)
        \u2714 Audit trail verified
        """
    
        client = APIClient()
    
        # -----------------------
        # Org + Clinician
        # -----------------------
        org = Organization.objects.create(
            name="E2E Clinic",
            code="E2E_ORG",
            signature_required=True
        )
    
        clinician = User.objects.create_user(
            username="doctor@e2e.com",
            password="pass"
        )
    
        UserProfile.objects.create(
            user=clinician,
            organization=org,
            role="CLINICIAN"
        )
    
        client.force_authenticate(user=clinician)
    
        # -----------------------
        # Catalog
        # -----------------------
        instrument = Instrument.objects.create(
            organization=org,
            code="PHQ9",
            name="PHQ-9"
        )
    
        TestDefinition.objects.create(
            organization=org,
            instrument=instrument,
            code="PHQ9_STD",
            name="PHQ-9",
            language="en",
            json_schema={"type": "object"},
            scoring_spec={},
            is_active=True
        )
    
        panel = Panel.objects.create(
            organization=org,
            code="PANEL_E2E",
            name="Mental Health Panel"
        )
    
        # -----------------------
        # Patient
        # -----------------------
        patient = Patient.objects.create(
            organization=org,
            name="E2E Patient"
        )
    
        # -----------------------
        # Order
        # -----------------------
        order = Order.objects.create(
            organization=org,
            patient=patient,
            panel=panel
        )
    
        # -----------------------
        # Session
        # -----------------------
        session = Session.objects.create(
            organization=org,
            order=order,
            status="COMPLETED"
        )
    
        # -----------------------
        # Report (READY û immutable)
        # -----------------------
        report = Report.objects.create(
            organization=org,
            session=session,
            status="READY",
            report_json={"result": "ok"}
        )
    
        # -----------------------
        # Signature
        # -----------------------
        ReportSignature.objects.create(
            organization=org,
            report=report,
            signer_name="Dr E2E",
            signer_reg_no="E2E-001",
            signer_role="CLINICIAN"
        )
    
        # -----------------------
        # Release
        # -----------------------
        resp = client.post(f"/api/v1/reports/{report.id}/release/")
        assert resp.status_code == 200
    
        # Original report must remain immutable
        report.refresh_from_db()
        assert report.status == "READY"
    
        # Audit log must exist
        assert AuditLog.objects.filter(
            organization=org,
            action="REPORT_RELEASED",
            entity_type="Report",
            entity_id=str(report.id),
        ).exists()
    
        # -----------------------
        # PDF GENERATION (INTERNAL)
        # -----------------------
        pdf_path = tmp_path / "report.pdf"
    
        context = {
            "patient_name": patient.name,
            "session_id": session.id,
            "tests": [
                {
                    "code": "PHQ9",
                    "score": 5,
                    "severity": "Mild"
                }
            ],
            "critical_self_harm": False,
            "engine_version": "v1",
            "report_schema_version": "1.0",
            "organization": {"name": org.name, "address": "Some Address"},
            "report_id": str(report.id),
        }
    
>       generate_report_pdf(str(pdf_path), context)

tests\e2e\test_full_pathology_flow.py:165: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

buffer = 'C:\\Users\\Hareesh\\AppData\\Local\\Temp\\pytest-of-Hareesh\\pytest-21\\test_full_pathology_flow0\\report.pdf'
report_json = {'critical_self_harm': False, 'engine_version': 'v1', 'organization': {'address': 'Some Address', 'name': 'E2E Clinic'}, 'patient_name': 'E2E Patient', ...}

    def generate_report_pdf(buffer, report_json):
        c = canvas.Canvas(buffer, pagesize=A4)
        width, height = A4
        y = height - 40
    
        # SECTION 1 ù HEADER
        c.setFont("Helvetica-Bold", 12)
        c.drawString(40, y, report_json["organization"]["name"])
    
        c.setFont("Helvetica", 9)
        y -= 14
        c.drawString(40, y, report_json["organization"]["address"] or "")
    
        c.setFont("Helvetica-Bold", 14)
        c.drawRightString(width - 40, height - 40, "Psychiatric Assessment Report")
    
        y -= 30
        c.setFont("Helvetica", 9)
        c.drawString(40, y, f"Report ID: {report_json['report_id']}")
        y -= 12
>       c.drawString(40, y, f"Report Date: {report_json['audit']['created_at']}")
                                            ^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'audit'

reports\pdf.py:27: KeyError
______________ test_signed_report_contains_signature_placeholder ______________

    def test_signed_report_contains_signature_placeholder():
        pdf_bytes = render_pdf_from_report_json_v1(
            _sample_report(has_flag=False, signed=True)
        )
        txt = pdf_bytes.decode("latin-1", errors="ignore")
    
>       assert "Reviewed By: Dr X" in txt
E       AssertionError: assert 'Reviewed By: Dr X' in '%PDF-1.4\n%\x93\x8c\x8b\x9e ReportLab Generated PDF document (opensource)\n1 0 obj\n<<\n/F1 2 0 R /F2 3 0 R\n>>\nendo...tLab generated PDF document -- digest (opensource)\n\n/Info 7 0 R\n/Root 6 0 R\n/Size 11\n>>\nstartxref\n6137\n%%EOF\n'

backend\clinical\reporting\tests\test_report_pdf_v1.py:128: AssertionError
============================== warnings summary ===============================
catalog\models.py:23
  C:\Users\Hareesh\Desktop\Main-Projects\neurova_backend_project\neurova_backend\catalog\models.py:23: PytestCollectionWarning: cannot collect test class 'TestDefinition' because it has a __init__ constructor (from: tests/e2e/test_full_pathology_flow.py)
    class TestDefinition(models.Model):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED backend/clinical/tests/test_pdf_audit.py::test_pdf_export_creates_at_audit_event
FAILED backend/clinical/tests/test_submission_integrity.py::test_submission_integrity_vulnerability
FAILED tests/e2e/test_full_pathology_flow.py::test_full_pathology_flow - KeyE...
FAILED backend/clinical/reporting/tests/test_report_pdf_v1.py::test_signed_report_contains_signature_placeholder
=================== 4 failed, 3 passed, 1 warning in 8.57s ====================
